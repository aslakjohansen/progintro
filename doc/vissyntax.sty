\NeedsTeXFormat{LaTeX2e}[1995/12/01]
\ProvidesPackage{vissyntax}[2025/02/28 v0.1
                 LaTeX package for visual BNF syntax figures]

% packages and TikZ librairies
\RequirePackage{geometry}
\RequirePackage{tikz}
\RequirePackage{newfloat}

% inspiration:
% - https://github.com/tofgarion/my-latex-packages/blob/master/my-tikz.sty
% - https://tex.stackexchange.com/questions/200187/how-to-define-a-special-tikz-node
% - https://www.tug.org/pracjourn/2006-1/schmidt/schmidt.pdf
% - https://mirrors.dotsrc.org/ctan/macros/latex/contrib/newfloat/newfloat.pdf

\DeclareFloatingEnvironment[
    fileext=los,
    listname={List of Syntax Defintions},
    name=Syntax,
    placement=tbp,
    within=chapter,
]{syntaxfloat}

\tikzset{textalign/.style={
  minimum height=5.5mm,
  text depth=0.7mm,
  text height=2.5mm,
}}

\tikzset{symbol/.style={
  draw,
  thick,
}}
\tikzset{empty/.style={
}}
\tikzset{terminal/.style={
  rectangle,
  draw=teal,
  text=teal,
  fill=teal!5,
  thick,
  font=\ttfamily,
  textalign,
}}
\tikzset{nonterminal/.style={
  rectangle,
  draw=purple,
  text=purple,
  fill=purple!5,
  thick,
  font=\slshape,
  textalign,
  rounded corners=1mm,
}}
\tikzset{nonterminal/.style={
  rectangle,
  draw=purple,
  text=purple,
  fill=purple!5,
  thick,
  font=\slshape,
  textalign,
  rounded corners=1mm,
}}
\tikzset{concept/.style={
  nonterminal,
  double,
}}
\tikzset{beginnode/.style={
  empty,
  circle,
  draw,
  inner sep=0pt,
  minimum size=1.6mm,
}}
\tikzset{endnode/.style={
  beginnode,
  fill=black,
  anchor=east,
}}

\tikzset{path/.style={
  >=stealth,
  draw=black,
  rounded corners=2mm,
}}

% https://tex.stackexchange.com/questions/45347/vertical-and-horizontal-lines-in-pgf-tikz
\tikzset{
  -|-/.style={
    to path={
      (\tikztostart) -| ($(\tikztostart)!#1!(\tikztotarget)$) |- (\tikztotarget)
      \tikztonodes
    }
  },
  -|-/.default=0.5,
  |-|/.style={
    to path={
      (\tikztostart) |- ($(\tikztostart)!#1!(\tikztotarget)$) -| (\tikztotarget)
      \tikztonodes
    }
  },
  |-|/.default=0.5,
}

\newenvironment{syntax}[2][]{
  \begin{tikzpicture}[remember picture,#1]
    \node[concept]   (concept) at (0,\SyntaxRow{0}) {#2};
    \node[beginnode] (begin)   at ([xshift=6mm]concept.east) {};
    \coordinate (endnoteref) at ($(begin.east -| current page.north west)$);
    \node[endnode]   (end)     at ([xshift=1in+\hoffset+\oddsidemargin+\textwidth]endnoteref) {};
}{
  \end{tikzpicture}
}



\newcommand{\SyntaxSingleLineWest}[1]{
  \coordinate (#1) at (begin);
}

\newcommand{\SyntaxRow}[1]{
  -8mm*#1
}

\newcommand{\SyntaxPathForward}[2]{
  \draw[path] (#1)--(#2);
}
\newcommand{\SyntaxPathForwardVertical}[2]{
  \draw[path] (#1)--($(#1)!0.5!([xshift=2cm]#1)$)|-(#2);
}

% --

\newcommand{\SyntaxPreviousNode}[0]{dummy}

\newenvironment{syntaxrule}[1]
{
  \renewcommand{\SyntaxPreviousNode}[0]{#1}
  \draw[path] (\SyntaxPreviousNode)
}{
  ;
}

\newcommand{\SyntaxForwardPathTo}[1]{
  --(#1)
  \renewcommand{\SyntaxPreviousNode}[0]{#1}
}
\newcommand{\SyntaxForwardVerticalPathTo}[1]{
  --($(\SyntaxPreviousNode)!0.5!([xshift=2cm]\SyntaxPreviousNode)$)|-(#1)
  \renewcommand{\SyntaxPreviousNode}[0]{#1}
}

