\centering

\rotatebox{90}{
\begin{tikzpicture}[]
  \newcommand{\Xpc}[0]{ 0mm }
  \newcommand{\Xim}[0]{ 32mm }
  \newcommand{\Xreg}[0]{ 56mm }
  \newcommand{\Xloadmux}[0]{ 65mm }
  \newcommand{\Xdm}[0]{ 80mm }
  \newcommand{\Ycenter}[0]{ 8mm }
  
  \newcommand{\tint}[0]{ 5 }
  
  \newcommand{\spacing}[0]{ 4mm }
  \newcommand{\lineheight}[0]{ 8mm }
  
  \newcommand{\andheight}[0]{ 8mm }
  \newcommand{\andwidth}[0]{ (1.5*\andheight) }
  \newcommand{\muxwidth}[0]{ 4mm }
  \newcommand{\muxheight}[0]{ (\spacing+2*\muxwidth) }
  \newcommand{\muxinputoffset}[0]{ (\spacing/2) }
  \newcommand{\aluheight}[0]{ 24mm }
  \newcommand{\aluwidth}[0]{ 12mm }
  \newcommand{\aluindent}[0]{ 3mm }
  \newcommand{\aluinputoffset}[0]{ (\aluheight/4+\aluindent/2) }
  
  \tikzstyle{edge}  = [thick,>=stealth,draw=black]
  \tikzstyle{dedge} = [thick,->,>=stealth,draw=black]
  \tikzstyle{control} = [
    draw=teal,
  ]
  \tikzstyle{block}=[
    rectangle,
    draw=purple,
    fill=purple!\tint,
    anchor=center,
    align=center,
    thick,
  ]
  \tikzstyle{mux}=[
    rectangle,
    draw=purple,
    fill=purple!\tint,
    anchor=center,
    align=center,
    rounded corners=\muxwidth/2,
    minimum width=\muxwidth,
    minimum height=\muxheight,
    thick,
  ]
  \tikzstyle{point}=[
    circle,
    fill=black,
    anchor=center,
    minimum size=0.9mm,
    inner sep=0pt,
    thick,
  ]
  
  % #1: prefix
  % #2: position
  \newcommand{\buildProgramCounterBlock}[2]{
    \node[
      block,
      anchor=west,
      minimum height=40mm,
    ] (#1) at (#2) {\textbf{PC}};
    
    \coordinate (#1 in)  at (#1.west);
    \coordinate (#1 out) at (#1.east);
  }
  
  % #1: prefix
  % #2: position
  \newcommand{\buildInstructionMemoryBlock}[2]{
    \node[
      block,
      anchor=west,
      minimum width=40mm,
      minimum height=40mm,
    ] (#1) at (#2) {};
    \node[anchor=south,align=center] () at (#1.south) {\textbf{Instruction}\\\textbf{Memory}};
    
    \coordinate (#1 addr) at ([yshift=0.0*\lineheight]#1.west);
    \coordinate (#1 inst) at ([yshift=0.0*\lineheight]#1.east);
    
    \node[anchor=west] () at (#1 addr) {Address};
    \node[anchor=east] () at (#1 inst) {Instruction};
  }
  
  % #1: prefix
  % #2: position
  \newcommand{\buildRegisterBlock}[2]{
    \node[
      block,
      anchor=west,
      minimum width=40mm,
      minimum height=40mm,
    ] (#1) at (#2) {};
    \node[anchor=west] () at (#1.center) {\rotatebox{90}{\textbf{Registers}}};
    
    \coordinate (#1 data)   at ([yshift= 1.5*\lineheight]#1.west);
    \coordinate (#1 regI)   at ([yshift= 0.5*\lineheight]#1.west);
    \coordinate (#1 regII)  at ([yshift=-0.5*\lineheight]#1.west);
    \coordinate (#1 regIII) at ([yshift=-1.5*\lineheight]#1.west);
    \coordinate (#1 valI)   at ([yshift= \aluinputoffset]#1.east);
    \coordinate (#1 valII)  at ([yshift=-\aluinputoffset+\muxinputoffset]#1.east);
    
    \node[anchor=west] () at (#1 data)   {Data};
    \node[anchor=west] () at (#1 regI)   {Register 1};
    \node[anchor=west] () at (#1 regII)  {Register 2};
    \node[anchor=west] () at (#1 regIII) {Register 3};
    \node[anchor=east] () at (#1 valI)   {Value 1};
    \node[anchor=east] () at (#1 valII)  {Value 2};
    
    \coordinate (#1 rw) at ([xshift=-2*\spacing]#1.south east);
  }
  
  % #1: prefix
  % #2: position
  \newcommand{\buildDataMemoryBlock}[2]{
    \node[
      block,
      anchor=west,
      minimum width=40mm,
      minimum height=40mm,
    ] (#1) at (#2) {};
    \node[anchor=south,align=center] () at (#1.south) {\textbf{Data}\\\textbf{Memory}};
    
    \coordinate (#1 addr)  at ([yshift= 1.0*\lineheight]#1.west);
    \coordinate (#1 data)  at ([yshift=-1.0*\lineheight]#1.west);
    \coordinate (#1 value) at ([yshift= 0.0*\lineheight]#1.east);
    
    \node[anchor=west] () at (#1 addr) {Address};
    \node[anchor=west] () at (#1 data) {Data};
    \node[anchor=east] () at (#1 value) {Value};
  }
  
  
  % #1: prefix
  % #2: position
  \newcommand{\buildALU}[3]{
    \coordinate (offset) at (#2);
    
    \draw[
      thick,
      draw=purple,
      fill=purple!\tint,
    ]  ([yshift=\aluheight/2]offset)
    -- ([xshift=\aluwidth,yshift= \aluheight/5]offset)
    -- ([xshift=\aluwidth,yshift=-\aluheight/5]offset)
    -- ([yshift=-\aluheight/2]offset)
    -- ([yshift=-\aluindent]offset)
    -- ([xshift=\aluindent]offset)
    -- ([yshift=\aluindent]offset)
    -- cycle;
    \node[anchor=center,align=center] () at ([xshift=\aluindent+\aluwidth/2-\aluindent/2]offset) {\rotatebox{90}{\textbf{#3}}};
    
    \coordinate (#1 iI)  at ([yshift= \aluinputoffset]offset);
    \coordinate (#1 iII) at ([yshift=-1*\aluinputoffset]offset);
    \coordinate (#1 o)   at ([xshift=\aluwidth]offset);
    \coordinate (#1 c)   at ([xshift=\aluwidth/2,yshift=-(\aluheight/5/2+\aluheight/2/2]offset);
    \coordinate (#1 z)   at ([xshift=\aluwidth/2,yshift= (\aluheight/5/2+\aluheight/2/2]offset);
  }
  
  % #1: prefix
  % #2: position
  \newcommand{\buildAND}[2]{
    \coordinate (offset) at (#2);
    
    \draw[
      thick,
      control,
      fill=teal!\tint,
    ]  ([xshift=\andwidth/2,yshift= \andheight/2]offset)
    -- ([xshift=\andwidth/2,yshift=-\andheight/2]offset)
    -- ([xshift=-(\andwidth/2-\andheight/2),yshift=-\andheight/2]offset)
    arc [x radius=\andheight/2,y radius=\andheight/2, start angle=270,end angle=90]
    -- cycle;
    \node[anchor=center,align=center] () at (offset) {\rotatebox{0}{\textbf{AND}}};
    
    \coordinate (#1 iI)  at ([xshift=\andwidth/2,yshift= \spacing/2]offset);
    \coordinate (#1 iII) at ([xshift=\andwidth/2,yshift=-\spacing/2]offset);
    \coordinate (#1 o)   at ([xshift=-\andwidth/2]offset);
  }
  
  % #1: prefix
  % #2: position
  \newcommand{\buildControlBlock}[2]{
    \node[
      block,
      anchor=north west,
      minimum width=32mm,
      minimum height=2*21mm,
      control,
      fill=teal!\tint,
    ] (#1) at (#2) {};
    \node[anchor=south west] () at ([xshift=\spacing,yshift=\spacing]#1.south west) {\rotatebox{90}{\textbf{Control}}};
    
    \coordinate (#1 Instruction) at ([xshift= 1.0*\spacing]#1.north west);
    \coordinate (#1 RegWrite)    at ([yshift= 2.1*\lineheight]#1.east);
    \coordinate (#1 ALUSrc)      at ([yshift= 1.4*\lineheight]#1.east);
    \coordinate (#1 ALUOp)       at ([yshift= 0.7*\lineheight]#1.east);
    \coordinate (#1 MemRead)     at ([yshift= 0.0*\lineheight]#1.east);
    \coordinate (#1 MemWrite)    at ([yshift=-0.7*\lineheight]#1.east);
    \coordinate (#1 MemtoReg)    at ([yshift=-1.4*\lineheight]#1.east);
    \coordinate (#1 Branch)      at ([yshift=-2.1*\lineheight]#1.east);
    
    \node[anchor=north] () at (#1 Instruction)   {\rotatebox{90}{Instruction}};
    \node[anchor=east] () at (#1 RegWrite) {RegWrite};
    \node[anchor=east] () at (#1 ALUSrc)   {ALUSrc};
    \node[anchor=east] () at (#1 ALUOp)    {ALUOp};
    \node[anchor=east] () at (#1 MemRead)  {MemRead};
    \node[anchor=east] () at (#1 MemWrite) {MemWrite};
    \node[anchor=east] () at (#1 MemtoReg) {MemtoReg};
    \node[anchor=east] () at (#1 Branch)   {Branch};
  }
  
  % #1: prefix
  % #2: position
  \newcommand{\buildLegend}[2]{
    \node[
      matrix,
      anchor=center,
      row sep=\spacing/2,
      column sep=\spacing/2,
      column 2/.style={anchor=west},
      ampersand replacement=\&,
    ] (#1) at (#2) {
      \node[
        block,
        minimum width=\spacing,
        minimum height=\spacing/4*3,
      ] () {};
      \&
      \node[] () {Data plane};
      \\
      \node[
        block,
        minimum width=\spacing,
        minimum height=\spacing/4*3,
        control,
        fill=teal!\tint,
      ] () {};
      \&
      \node[] () {Control plane};
      \\
    };
  }
  
  % program counter
  \buildProgramCounterBlock{pc}{0,0}
  
  % instruction memory
  \buildInstructionMemoryBlock{im}{[xshift=2*\spacing]pc.east}
  
  % instruction increment alu
  \buildALU{alu incr}{[xshift=-\aluwidth/2,yshift=5*\spacing]im.north}{+}
  \node[anchor=east] (inst size) at ([xshift=-\spacing]alu incr iI) {4};
  \draw[dedge] (inst size) -- (alu incr iI);
  
  % registers
  \buildRegisterBlock{reg}{[xshift=3*\spacing]im.east}
  
  % branch alu
  \buildALU{alu branch}{[xshift=-\aluwidth/2,yshift=5*\spacing]reg.north}{+}
  
  % alu
  \buildALU{alu}{[xshift=3*\spacing+\muxwidth+\spacing] reg.east}{ALU}
  
  % immediate mux
  \node[mux,anchor=east] (immediatemux) at ([xshift=-\spacing]alu iII) {\rotatebox{90}{mux}};
  
  % data memory
  \buildDataMemoryBlock{dm}{[xshift=2*\spacing,yshift=-\lineheight]alu o}
  
  % load mux
  \node[mux,anchor=east] (loadmux) at ([xshift=4*\spacing,yshift=\spacing]reg.north east) {\rotatebox{90}{mux}};
  
  % pc mux
  \node[mux,anchor=east] (pcmux) at ([xshift=-\muxwidth,yshift=2*\spacing+\aluheight+\spacing+\muxheight/2-(\muxheight/2-\muxinputoffset)]im.north west) {\rotatebox{90}{mux}};
%  \node[mux,anchor=east] (pcmux) at ([xshift=-\muxwidth,yshift=10*\spacing]im.north west) {\rotatebox{90}{mux}};
  
  % control
  \buildControlBlock{control}{[yshift=-2*\spacing]im.south east}
  
  % control and
  \buildAND{and}{[xshift=\spacing,yshift=\spacing]$(reg.north east)!(pcmux.north)!(reg.south east)$}
  
  % control wiring
  \draw[dedge,control] (control RegWrite) -| (reg rw);
  \draw[dedge,control] (control ALUSrc) -| (immediatemux.south);
  \draw[dedge,control] (control ALUOp) -| (alu c);
  \draw[dedge,control] (alu z) |- (and iII);
  \draw[dedge,control] (and o) -| (pcmux.north);
  \draw[dedge,control] (control MemRead) -| ([xshift=-3*\spacing]dm.south);
  \draw[dedge,control] (control MemWrite) -| ([xshift=3*\spacing]dm.south);
  \draw[dedge,control] (control MemtoReg)
                    -- ([xshift=2*\spacing] $(dm.north east)!(control MemtoReg)!(dm.south east)$)
                    |- ([yshift=\spacing]loadmux.north)
                    -- (loadmux.north);
  \draw[dedge,control] (control Branch)
                    -- ([xshift=3*\spacing] $(dm.north east)!(control Branch)!(dm.south east)$)
                    |- (and iI);
  
  % wiring
  \draw[dedge] (pc out) -- (im addr);
  \draw[dedge] ($(pc out)!0.5!(im addr)$) |- (alu incr iII);
  \draw[dedge] ([xshift=-\spacing,yshift=\spacing]im.north west)
            -- ([xshift=-\spacing,yshift=\spacing]im.north east)
            |- (alu branch iI);
  \draw[dedge] (im inst)
            -- ([xshift=\spacing]im inst)
            |- ([xshift=\spacing,yshift=-\spacing]reg.south east)
            |- ([yshift=-\muxinputoffset]immediatemux.west);
  \draw[dedge] ([xshift=\spacing]im inst)
            |- (alu branch iII);
  \draw[dedge] ([xshift=-2*\spacing]reg regI)   -- (reg regI);
  \draw[dedge] ([xshift=-2*\spacing]reg regII)  -- (reg regII);
  \draw[dedge] ([xshift=-2*\spacing]reg regIII) -- (reg regIII);
  \draw[dedge] ([yshift=1*\spacing]control Instruction) -- (control Instruction);
  \draw[dedge] (reg valI) -- (alu iI);
  \draw[dedge] (reg valII) -- ([yshift=\muxinputoffset] immediatemux.west);
  \draw[dedge] ([xshift=2*\spacing]reg valII) |- (dm data);
  \draw[dedge] (immediatemux) -- (alu iII);
  \draw[dedge] (alu o) -- (dm addr);
  \draw[dedge] ([xshift=\spacing]alu o)
            |- ([yshift=-\muxinputoffset]loadmux.east);
  \draw[dedge] (dm value)
            -- ([xshift=\spacing]dm value)
            |- ([yshift=\muxinputoffset]loadmux.east);
  \draw[dedge] (loadmux.west)
            -- ([xshift=-\spacing,yshift=\spacing]reg.north west)
            |- (reg data);
  \draw[dedge] (alu incr o)
            -- ([xshift=\spacing]alu incr o)
            |- ([yshift=-\muxinputoffset]pcmux.east);
  \draw[dedge] (alu branch o)
            -- ([xshift=\spacing]alu branch o)
            |- ([yshift=\muxinputoffset]pcmux.east);
  \draw[dedge] (pcmux.west)
            -| ([xshift=-\spacing]pc.west)
            |- (pc);
  
  % connection points
  \node[point] () at ([xshift=\spacing]pc.east) {};
  \node[point] () at ([xshift=-\spacing,yshift=\spacing]im.north west) {};
  \node[point] () at ([xshift= 1*\spacing]im inst) {};
  \node[point] () at ([xshift=-2*\spacing]reg regI) {};
  \node[point] () at ([xshift=-2*\spacing]reg regII) {};
  \node[point] () at ([xshift=-2*\spacing]reg regIII) {};
  \node[point] () at ([xshift=2*\spacing]reg valII) {};
  \node[point] () at ([xshift= 1*\spacing]alu o) {};
  \node[point] () at ([yshift=1*\spacing]control Instruction) {};
  
  % legend
  \buildLegend{legend}{$($(pc.north west)!0.5!(im.north east)$)!(control.west)!($(pc.south west)!0.5!(im.south east)$)$}
\end{tikzpicture}
}
