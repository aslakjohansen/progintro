\section{The Machine}
\label{sec:machine}

\subsection{History}

% Antikythera mechanism https://en.wikipedia.org/wiki/Antikythera_mechanism

% Jacquard machine https://en.wikipedia.org/wiki/Jacquard_machine

% Difference Engine https://en.wikipedia.org/wiki/Difference_engine

% Mutual Exclusion https://en.wikipedia.org/wiki/Mutual_exclusion

% C https://en.wikipedia.org/wiki/C_(programming_language)

% Taming of the Alpaca

\subsection{Overview}

% description of computer: model description as data flow (input, memory, processor, load instruction, registers, operator instructions, ALU, store instruction, memory, output)
Figure \ref{fig:machine:computer}

\begin{figure}[tbp]
  \input{figs/machine_computer.tex}
  \caption{Model of computer.}
  \label{fig:machine:computer}
\end{figure}

\subsection{Memory Model}

\begin{figure}[tbp]
  \input{figs/machine_memory.tex}
  \caption{Memory model.}
  \label{fig:machine:memory}
\end{figure}

\subsection{Registers}

% how many, special roles?

% figure: caller saved, callee saved

\subsection{Instructions}

\subsubsection{Memory Access}

\subsubsection{Arithmetic Operations}

\subsubsection{Choice}

\begin{itemize}
  \item \texttt{J} (\say{jump}) Jump to a specific memory address.
  \item \texttt{JAL} (\say{jump and link}) Jump to a specific memory address, and \textsl{link}.
\end{itemize}

\subsection{Big Picture}

% intro
The components that of the machine that we have covered can be put together around the central processing unit (i.e., the \idx{CPU}{CPU}). An implementation of a primitive RISC-V processor is illustrated in figure \ref{fig:machine:riscv}. In reality, it is much more complicated, and RISC-V is a simple \idx{processor architecture}{Architecture!Processor}. Lets briefly go through what is going on in this figure.

\begin{figure}[tbp]
  \input{figs/machine_riscv.tex}
  \caption{Primitive model of a RISC-V Processor.}
  \label{fig:machine:riscv}
\end{figure}

% signals: bloacks and arrows, complex blocks, what complex mean, signals (1 or more bits), control and data
The diagram consists of various blocks connected by arrows. These blocks are \idx{complex}{Complex!Block}. That is, they represent a \idx{logical}{Logical} unit but are physically constructed from smaller parts \ldots\ with arrows between them. We call the arrows \idx{signals}{Signal}. They represent a value of one or more bits. One can think of them as how data flows through the processor. Concretely, this is accomplished through \idx{register transfer level}{Register Transfer Level} (RTL) logic and a \idx{clock signal}{Signal!Clock}. But then things get really complicated, and we don't need it that badly.

% data and control plane:
Some of these signals exists to move data around between memory, registers and the implementation of the instructions. These are called \idx{data signals}{Signal!Data}, and we say that these make up the \defi{data plane}{Plane!Data}. This is a cross-cut of the processor through which \say{data flows}. Other signals are \idx{control signals}{Signal!Control}, and they make up the \defi{control plane}{Plane!Control}. That is a different cross-cut that informs the blocks of \textsl{how} they should operate. For instance, the block that executes the instructions is called an ALU. It has a number of generic inputs and a control signal tells it which operation (e.g., an addition or a division) it is supposed to perform on these.

% alu: identifying the component visually, much more complicated block, interface (two data inputs, one control input, one data output, one control output, one control output), perform the operation specified by the control input on the data inputs and output the resulting value on the data output, boolean signal for whether a branch should be taken, two variations (the generic one covered here, a specialized version that can only add and has no control interface)
There are three \idx{ALUs}{ALU} on the diagram. They look a bit like an arrow pointing to the right and are labeled either \say{ALU} or \say{+}. The latter version is a specialized version of the former. The specialized version takes two data inputs and produces a data output. This output is the result of adding the two inputs. The generic version has a control input which tells it which operation to perform. This ALU supports a large number of operations, and will perform the operation specified by the control input on the data inputs and output the resulting value on the data output. For \idx{arithmetic operations}{Operation!Arithmetic}, this is straight forward to imagine: If the control signal specifies a multiplication operation and the data inputs a two and three, then the data output becomes six. Other operations are used to transfer the control flow from one place in \idx{instruction memory}{Memory!Instruction} to another. This can be either conditional (e.g., using the \idx{BNE}{BNE@\texttt{J} instruction} or \idx{BLT}{BLT@\texttt{BLT} instruction} instruction) or unconditional (e.g., using the \idx{J}{J@\texttt{J} instruction} or \idx{JAL}{JAL@\texttt{JAL} instruction} instruction). If a branch operation needs to be executed, the ALU will indicate this using its control output signal.

% and: identifying the component visually, interface (number of inputs, one output), what the output represent
If we follow that control signal from the ALU, we will find a shape labeled \say{AND} that on the input side looks like a rectangle and on the output side it looks like a circle. It is an \idx{AND gate}{Gate!AND}. That is a piece of \idx{digital electronics}{Electronics!Digital} that produces a signal that represents whether all of the inputs are true.

% multiplexers (mux): identifying the component visually, interface (number of inputs, one output, a control), role of control
In the diagram, you will find three \idx{multiplexers}{Multiplexer} (or \idx{mux}{Mux} for short). These are labeled \say{mux}. They each have one outgoing edge, two incoming black edges, and one incoming \textsl{colored} edge. The mux is a selective forwarding mechanism, based on the value of the colored input, it forwards the value on one of the black inputs to its output. For this reason, the colored input is called a \idx{control signal}{Signal!Control}.

\subsubsection{Data Plane}

% pc: a register (something that can hold a value), usually increments in steps of 4, why that is

% instruction fetch and decode: the next step is to fetch that instruction (at that address) from instruction memory and decode it into its principal components, this usually includes instruction identity and a number of registers or immediate values

% register read: reading the values of each of these registers, register bank

% alu operation: operands to alu, register vs immediate value, control module tells it which operation to perform, many operations will require the result of the operation to be written back to the register bank

% memory operation: other operations will need to store the value of some register to memory, how does this value get from the register to the data input of data memory?

% branching

\subsubsection{Control Plane}

% the clock cycle ticks

% ALU signals: ALUOp for choosing operation, output for making jumps, when do we need to make jumps? (unconditional and conditional)

% Branch

% MemRead & MemWrite

% RegWrite & MemtoReg: two classes of operations (whether a write to a register is part of the operation), how RegWrite fits in, two classes of operations when a write is part of the operation (depending on the source of the write), do we write the output from the ALU (e.g., as in a plus operation) or do we write data that are loaded from data memory (e.g., as in a load operation).

\subsection{Takeaway}

% why languages tend to look the same
You will find that many of the design choices of \csharp, and any other programming language for that matter, have their roots in this machine. There is a reason why these languages look like the do. At the end of the day, they have to be executed on a physical processor, and often there is really only one way of doing something on such a processor that doesn't incur a huge performance penalty.

